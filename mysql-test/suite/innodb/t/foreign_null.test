--source include/have_innodb.inc
let $algorithm=`select regexp_replace('$MTR_COMBINATIONS', 'innodb,\|,innodb', '')`;
let $error_code = 0;

echo $algorithm;

if ($algorithm == "COPY") {
 let $error_code = ER_FK_COLUMN_CANNOT_CHANGE;
}

if ($algorithm == "INPLACE") {
 let $error_code = ER_FK_COLUMN_NOT_NULL;
}

# MODIFY CHILD COLUMN..NOT NULL ON UPDATE CASCADE.. PARENT COLUMN NULL
CREATE TABLE t1(f1 INT, f2 INT, PRIMARY KEY(f1), KEY(f2))ENGINE=InnoDB;
CREATE TABLE t2(f1 INT, FOREIGN KEY(f1) REFERENCES t1(f2) ON UPDATE CASCADE)ENGINE=InnoDB;
--error $error_code
eval ALTER TABLE t2 MODIFY COLUMN f1 INT NOT NULL, algorithm=$algorithm;
DROP TABLE t2, t1;

# MODIFY CHILD COLUMN..NOT NULL ON DELETE|ON UPDATE SET NULL
CREATE TABLE t1(f1 INT, f2 INT, PRIMARY KEY(f1), KEY(f2))ENGINE=InnoDB;
CREATE TABLE t2(f1 INT, f2 INT, FOREIGN KEY(f1) REFERENCES t1(f1) ON UPDATE SET NULL, FOREIGN KEY (f2) REFERENCES t1(f2) ON DELETE SET NULL)ENGINE=InnoDB;
--error $error_code
eval ALTER TABLE t2 MODIFY COLUMN f2 INT NOT NULL, ALGORITHM=$algorithm;
--error $error_code
eval ALTER TABLE t2 MODIFY COLUMN f1 INT NOT NULL, ALGORITHM=$algorithm;
DROP TABLE t2, t1;


let $error_code = ER_FK_COLUMN_CANNOT_CHANGE_CHILD;

# MODIFY PARENT COLUMN.. NULL.. ON UPDATE CASCADE CHILD.. NOT NULL
CREATE TABLE t1(f1 INT, f2 INT NOT NULL, PRIMARY KEY(f1), KEY(f2))ENGINE=InnoDB;
CREATE TABLE t2(f1 INT NOT NULL, FOREIGN KEY(f1) REFERENCES t1(f2) ON UPDATE CASCADE)ENGINE=InnoDB;
--error $error_code
eval ALTER TABLE t1 MODIFY COLUMN f2 INT, ALGORITHM=$algorithm;
DROP TABLE t2, t1;

# ALLOW FOREIGN KEY CONSTRAINTS WHEN PARENT TABLE CREATED LATER
SET FOREIGN_KEY_CHECKS=0;
CREATE TABLE t2(f1 INT, FOREIGN KEY(f1) REFERENCES t1(f2) ON UPDATE CASCADE)ENGINE=InnoDB;
ALTER TABLE t2 MODIFY COLUMN f1 INT NOT NULL;
SET FOREIGN_KEY_CHECKS=1;
CREATE TABLE t1(f1 INT, f2 INT, PRIMARY KEY(f1), KEY(f2))ENGINE=InnoDB;
INSERT INTO t1 VALUES(1, 1);
INSERT INTO t2 VALUES(1);
--error ER_ROW_IS_REFERENCED_2
UPDATE t1 SET f2= NULL;
SELECT * FROM t2;
SET FOREIGN_KEY_CHECKS=0;
UPDATE t1 SET f2= NULL;
SELECT * FROM t2;
DROP TABLE t2, t1;
