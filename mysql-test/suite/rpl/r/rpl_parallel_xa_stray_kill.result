include/master-slave.inc
[connection master]
ALTER TABLE mysql.gtid_slave_pos ENGINE=InnoDB;
CREATE TABLE t1 (a INT PRIMARY KEY, b INT) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1,0), (2,0), (3,0), (4,0), (5,0);
connection slave;
include/stop_slave.inc
SET @old_parallel_threads                    = @@GLOBAL.slave_parallel_threads;
SET @@global.slave_parallel_threads          = 2;
SET @old_slave_domain_parallel_threads       = @@GLOBAL.slave_domain_parallel_threads;
SET @@global.slave_domain_parallel_threads = 1;
SET @old_parallel_mode               = @@GLOBAL.slave_parallel_mode;
SET @@global.slave_parallel_mode     ='optimistic';
CHANGE MASTER TO master_use_gtid= slave_pos;
SET @old_dbug= @@GLOBAL.debug_dbug;
SET GLOBAL debug_dbug= "+d,xa_prepare_stray_deadlock_kill";
connection slave1;
BEGIN;
SELECT * FROM t1 WHERE a=1 FOR UPDATE;
a	b
1	0
connect con1,localhost,root,,;
SET SESSION gtid_domain_id=1;
XA START 't1';
UPDATE t1 SET b=1 WHERE a=1;
UPDATE t1 SET b=1 WHERE a=2;
XA END 't1';
XA PREPARE 't1';
XA COMMIT 't1';
connection master1;
XA START 't2';
UPDATE t1 SET b=2 WHERE a=2;
XA END 't2';
XA PREPARE 't2';
XA COMMIT 't2';
connection master;
include/save_master_gtid.inc
connection slave;
include/start_slave.inc
connection slave1;
ROLLBACK;
connection slave;
include/sync_with_master_gtid.inc
SET GLOBAL debug_dbug= @old_dbug;
SELECT * FROM t1 ORDER BY a;
a	b
1	1
2	1
3	0
4	0
5	0
connection master;
DROP TABLE t1;
connection slave;
include/stop_slave.inc
SET @@global.slave_parallel_mode           = @old_parallel_mode;
SET @@global.slave_parallel_threads        = @old_parallel_threads;
SET @@global.slave_domain_parallel_threads = @old_slave_domain_parallel_threads;
include/start_slave.inc
include/rpl_end.inc
